<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Blueprint Builder</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Instrument+Serif:ital@0;1&display=swap');
  *{margin:0;padding:0;box-sizing:border-box}
  :root{
    --bg:#0e0e0e;--surface:#161616;--surface-2:#1e1e1e;--border:#2a2a2a;--border-active:#4a4a4a;
    --text:#e0ddd5;--text-dim:#7a7770;--accent:#c9a55a;--accent-dim:#8a7340;
    --act-setup:#4a6670;--act-fall:#6a5a70;--act-retreat:#704a4a;--act-resolution:#4a7050;
    --selected:#2a2518;--selected-border:#c9a55a;--endstate:#4a6670;
    --cast-passion:#c97a5a;--cast-caution:#7a8a9a;--cast-dignity:#8a9a6a;--cast-tender:#9a7a9a;--cast-rival:#9a6a6a;
  }
  body{background:var(--bg);color:var(--text);font-family:'DM Mono',monospace;font-size:13px;line-height:1.6;padding:32px;min-height:100vh}
  header{margin-bottom:40px;border-bottom:1px solid var(--border);padding-bottom:24px}
  h1{font-family:'Instrument Serif',serif;font-size:28px;font-weight:400;color:var(--accent);letter-spacing:0.02em;margin-bottom:4px}
  .version{font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em}
  .variables{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:40px}
  .variable-card{background:var(--surface);border:1px solid var(--border);padding:14px 18px;flex:1;min-width:130px}
  .variable-card label{display:block;font-size:10px;text-transform:uppercase;letter-spacing:0.12em;color:var(--text-dim);margin-bottom:8px}
  .variable-card select{width:100%;background:var(--surface-2);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:12px;padding:8px 10px;cursor:pointer;appearance:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%237a7770'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center}
  .variable-card select:focus{outline:none;border-color:var(--accent-dim)}
  .variable-card select:disabled{opacity:0.3;cursor:not-allowed}
  .cast-section{margin-bottom:40px;border:1px solid var(--border);padding:20px 24px;background:var(--surface)}
  .cast-title{font-family:'Instrument Serif',serif;font-size:20px;font-weight:400;color:var(--accent);margin-bottom:16px}
  .cast-grid{display:flex;flex-direction:column;gap:8px}
  .cast-member{background:var(--surface-2);border:1px solid var(--border);padding:10px 14px}
  .cast-function{font-size:12px;color:var(--text);margin-bottom:4px;display:flex;align-items:center;gap:8px}
  .cast-dot{width:8px;height:8px;border-radius:50%;display:inline-block;flex-shrink:0}
  .cast-desc{font-size:10px;color:var(--text-dim);margin-bottom:6px}
  .cast-emp{font-size:10px;color:var(--text-dim);margin-left:16px;padding-left:10px;border-left:1px solid var(--border)}
  .cast-emp div{padding:1px 0}
  .cast-emp div::before{content:"→ ";color:var(--accent-dim)}
  .acts{display:flex;flex-direction:column;gap:2px}
  .act{display:grid;grid-template-columns:200px 1fr;min-height:80px;border:1px solid var(--border)}
  .act-label{display:flex;flex-direction:column;justify-content:center;padding:20px 24px;border-right:1px solid var(--border)}
  .act-label .act-number{font-size:10px;text-transform:uppercase;letter-spacing:0.12em;color:var(--text-dim);margin-bottom:4px}
  .act-label .act-name{font-family:'Instrument Serif',serif;font-size:20px;font-weight:400}
  .act:nth-child(1) .act-label{border-left:3px solid var(--act-setup)}
  .act:nth-child(2) .act-label{border-left:3px solid var(--act-fall)}
  .act:nth-child(3) .act-label{border-left:3px solid var(--act-retreat)}
  .act:nth-child(4) .act-label{border-left:3px solid var(--act-resolution)}
  .act-content{padding:20px 24px;background:var(--surface);color:var(--text-dim);font-style:italic;display:flex;align-items:center}
  .chapters{display:flex;flex-direction:column;gap:6px;width:100%}
  .chapter{background:var(--surface-2);border:1px solid var(--border);padding:10px 14px;font-style:normal;color:var(--text);font-size:12px}
  .ch-num{color:var(--text-dim);margin-right:10px;font-size:10px}
  .end-state{margin-top:6px;padding:6px 10px;font-size:10px;color:var(--endstate);border-left:2px solid var(--endstate);font-style:italic}
  .end-state::before{content:"END STATE: ";font-style:normal;font-size:9px;letter-spacing:0.08em;opacity:0.7}
  .employment-options{margin-top:8px;margin-left:20px;padding-left:10px;border-left:1px solid var(--border)}
  .emp-header{font-size:9px;text-transform:uppercase;letter-spacing:0.12em;color:var(--accent-dim);margin-bottom:4px}
  .emp-option{font-size:11px;color:var(--text-dim);padding:5px 8px;margin:2px 0;cursor:pointer;border:1px solid transparent;transition:all 0.15s ease}
  .emp-option::before{content:"○ ";color:var(--accent-dim)}
  .emp-option:hover:not(.disabled){background:var(--surface);border-color:var(--border-active);color:var(--text)}
  .emp-option.selected{background:var(--selected);border-color:var(--selected-border);color:var(--accent)}
  .emp-option.selected::before{content:"● ";color:var(--accent)}
  .emp-option.disabled{opacity:0.25;cursor:not-allowed;text-decoration:line-through}
  .emp-option.disabled::before{content:"✕ "}
  .constraint-note{font-size:9px;color:var(--act-retreat);margin-top:4px;font-style:italic;display:none}
  .constraint-note.visible{display:block}
  .conditional-note{font-size:9px;color:var(--accent);margin-top:6px;font-style:italic;display:none;padding:4px 8px;border-left:2px solid var(--accent-dim)}
  .conditional-note.visible{display:block}
  .sub-options{margin-top:6px;margin-left:12px;padding-left:10px;border-left:1px solid var(--accent-dim);display:none}
  .sub-options.visible{display:block}
  .cascading-note{font-size:9px;color:var(--accent-dim);margin-top:4px;font-style:italic;padding:4px 8px;border-left:1px solid var(--accent-dim);margin-left:20px}
  .toggle-block{display:none}
  .toggle-block.visible{display:block}
  .selection-summary{margin-top:24px;padding:14px 18px;background:var(--surface);border:1px solid var(--border);font-size:11px}
  .sum-header{font-size:9px;text-transform:uppercase;letter-spacing:0.12em;color:var(--accent-dim);margin-bottom:8px}
  .sum-item{color:var(--text-dim);padding:2px 0}
  .sum-item span{color:var(--accent)}
  footer{margin-top:40px;padding-top:16px;border-top:1px solid var(--border);font-size:11px;color:var(--text-dim);display:flex;justify-content:space-between}
</style>
</head>
<body>

<header>
  <h1>Blueprint Builder</h1>
  <div class="version">v2.7 — Identity Cast Complete</div>
</header>

<!-- VARIABLES -->
<section class="variables">
  <div class="variable-card"><label>Trope</label><select id="trope"><option value="enemies_to_lovers" selected>Enemies to Lovers</option><option value="strangers_to_lovers" disabled>Strangers to Lovers</option></select></div>
  <div class="variable-card"><label>Tension</label><select id="tension" onchange="updateAll()"><option value="safety" selected>Safety vs Passion</option><option value="identity">Identity vs Passion</option></select></div>
  <div class="variable-card"><label>Ending</label><select id="ending" onchange="updateAll()"><option value="hea">HEA</option><option value="bittersweet">Bittersweet</option><option value="tragic">Tragic</option></select></div>
  <div class="variable-card"><label>Secret</label><select id="secret" onchange="updateAll()"><option value="yes">Yes</option><option value="no">No</option></select></div>
  <div class="variable-card"><label>Triangle</label><select id="triangle" onchange="updateAll()"><option value="yes">Yes</option><option value="no">No</option></select></div>
</section>

<!-- CAST -->
<section class="cast-section">
  <div class="cast-title">Supporting Cast — Thematic Functions</div>

  <!-- SAFETY CAST -->
  <div class="cast-grid toggle-block visible" id="cast-safety">
    <div class="cast-member">
      <div class="cast-function"><span class="cast-dot" style="background:var(--cast-passion)"></span> All Passion, No Fear</div>
      <div class="cast-desc">Believes passion is the whole answer. No caution, no consequences. Makes the protagonist's restraint look like cowardice.</div>
      <div class="cast-emp"><div>A younger sister or cousin</div><div>A best friend or close companion</div><div>A female colleague or peer in the same world</div><div>A servant or attendant with proximity to her private life</div></div>
    </div>
    <div class="cast-member">
      <div class="cast-function"><span class="cast-dot" style="background:var(--cast-caution)"></span> Burned by Danger</div>
      <div class="cast-desc">Destroyed by danger and now lives inside walls. Her caution is earned. Represents the future if fear wins.</div>
      <div class="cast-emp"><div>A mother or grandmother who lost someone to danger</div><div>An older female relative — chose danger once and paid</div><div>A widow — her story is the cautionary tale</div><div>A female elder in the community — respected, protective</div><div>A former version of the protagonist's role</div></div>
    </div>
    <div class="cast-member">
      <div class="cast-function"><span class="cast-dot" style="background:var(--cast-dignity)"></span> Voice of the Dignified Life</div>
      <div class="cast-desc">Chose safety and made it noble through effort and loyalty. Proves the safe path has real value.</div>
      <div class="cast-emp"><div>Her father</div><div>A senior figure in her profession — foreman, mentor, veteran</div><div>An elderly male relative — uncle, grandfather</div><div>A neighbour or community figure who built something through patience</div></div>
    </div>
    <div class="cast-member">
      <div class="cast-function"><span class="cast-dot" style="background:var(--cast-tender)"></span> Someone the Primary Protects</div>
      <div class="cast-desc">Can't protect themselves. The primary protects them anyway. She sees him be tender and her framework breaks.</div>
      <div class="cast-emp"><div>A child he's responsible for — his own, an orphan, a ward</div><div>A younger sibling or relative he raised</div><div>An elderly parent or grandparent he cares for</div><div>A loyal subordinate who depends on him</div><div>A vulnerable person others abandoned but he hasn't</div></div>
    </div>
    <div class="cast-member toggle-block" id="cast-rival-safety">
      <div class="cast-function"><span class="cast-dot" style="background:var(--cast-rival)"></span> The Rival</div>
      <div class="cast-desc">The safe option personified. His flaw cascades from flicker to full exposure.</div>
    </div>
  </div>

  <!-- IDENTITY CAST -->
  <div class="cast-grid toggle-block" id="cast-identity">
    <div class="cast-member">
      <div class="cast-function"><span class="cast-dot" style="background:var(--cast-passion)"></span> The Source</div>
      <div class="cast-desc">Where the identity came from. Their approval is what the framework was built to earn. She can't change without confronting this origin.</div>
      <div class="cast-emp"><div>A parent she modelled herself on</div><div>A mentor or teacher who shaped her framework</div><div>A formative figure from her past — no longer present but their influence is the architecture</div><div>An older sibling she grew up admiring</div></div>
    </div>
    <div class="cast-member">
      <div class="cast-function"><span class="cast-dot" style="background:var(--cast-caution)"></span> The Validator</div>
      <div class="cast-desc">Confirms her framework is correct. Takes her side. Reflects her judgments back uncritically. Makes the identity feel earned and shared rather than constructed.</div>
      <div class="cast-emp"><div>A best friend or close peer who shares her worldview</div><div>A colleague or rival who operates by the same rules</div><div>A confidant who reflects her judgments back to her uncritically</div></div>
    </div>
    <div class="cast-member">
      <div class="cast-function"><span class="cast-dot" style="background:var(--cast-dignity)"></span> What She's Afraid Of Becoming</div>
      <div class="cast-desc">The undisciplined, out-of-control, or degraded version. The reason the framework exists. Every time she sees this person, she grips tighter.</div>
      <div class="cast-emp"><div>A parent or relative who represents the undisciplined version</div><div>A sibling or peer who abandoned the same standards</div><div>A public figure in her world who lost standing or control</div><div>A former version of herself she's buried</div></div>
    </div>
    <div class="cast-member">
      <div class="cast-function"><span class="cast-dot" style="background:var(--cast-tender)"></span> The One Who Let Go</div>
      <div class="cast-desc">Chose differently. Abandoned the framework or broke ranks. Either it destroyed them or freed them. Either way, she can't look at them without seeing a possible future.</div>
      <div class="cast-emp"><div>A friend or peer who chose differently and survived — or didn't</div><div>A sibling who took the other path</div><div>Someone from her world who broke ranks and either thrived or was destroyed</div></div>
    </div>
    <div class="cast-member">
      <div class="cast-function"><span class="cast-dot" style="background:var(--cast-rival)"></span> Someone He's Genuine With</div>
      <div class="cast-desc">Can't protect themselves. He protects them anyway. She sees him be tender and her categorisation breaks. Trope-level — shared across tensions.</div>
      <div class="cast-emp"><div>A child he's responsible for — his own, an orphan, a ward</div><div>A younger sibling or relative he raised</div><div>An elderly parent or grandparent he cares for</div><div>A loyal subordinate who depends on him</div><div>A vulnerable person others abandoned but he hasn't</div></div>
    </div>
  </div>

</section>

<!-- ACTS -->
<section class="acts">

<!-- ════════════════════════════════ ACT I ════════════════════════════════ -->
<div class="act">
  <div class="act-label"><span class="act-number">Act I</span><span class="act-name">The Setup</span></div>
  <div class="act-content"><div class="chapters">

    <!-- CH.1 -->
    <div class="chapter">
      <span class="ch-num">1</span> Establish Her World
      <div class="end-state toggle-block visible" id="ch1-es-default">By the end, the reader understands what makes her vulnerable.</div>
      <div class="end-state toggle-block" id="ch1-es-safe">By the end, the reader understands what she stands to lose.</div>
      <div class="end-state toggle-block" id="ch1-es-identity">By the end, the reader understands who she has built herself to be.</div>
      <div class="conditional-note" id="ch1-rival-note">+ The rival is established as part of her world</div>

      <!-- SAFETY CH.1 -->
      <div class="toggle-block visible" id="ch1-safety">
        <div class="employment-options"><div class="emp-header">Employment Options</div>
          <div class="emp-option" data-ch="1" data-opt="precarious" onclick="sel(this)">She has built something fragile that sustains her — a business, a home, a livelihood. It works, but it wouldn't survive a shock</div>
          <div class="emp-option" data-ch="1" data-opt="hurt_before" onclick="sel(this)">She has been hurt before — by a person, by an event, by loss. Her world is organised around that wound</div>
          <div class="emp-option" data-ch="1" data-opt="safety_scarce" onclick="sel(this)">She lives in a world where safety is scarce — a frontier, a contested territory, an unstable community. What she has is the exception</div>
          <div class="emp-option" data-ch="1" data-opt="safe_stable" onclick="sel(this)">Her world is safe, stable, and unremarkable — nothing is broken, nothing is threatened. The danger when it arrives is something she's never imagined</div>
        </div>
      </div>

      <!-- IDENTITY CH.1 -->
      <div class="toggle-block" id="ch1-identity">
        <div class="employment-options"><div class="emp-header">Employment Options</div>
          <div class="emp-option" data-ch="1" data-opt="competence" onclick="sel(this)">She is defined by her competence — she's the best at what she does and that's who she is</div>
          <div class="emp-option" data-ch="1" data-opt="principles" onclick="sel(this)">She is defined by her principles — a moral or intellectual framework that governs everything</div>
          <div class="emp-option" data-ch="1" data-opt="role" onclick="sel(this)">She is defined by her role — daughter, leader, professional, caretaker. The role IS her</div>
          <div class="emp-option" data-ch="1" data-opt="rejection" onclick="sel(this)">She is defined by what she's rejected — she built herself in opposition to something, a past, a class, a world</div>
          <div class="emp-option" data-ch="1" data-opt="reputation" onclick="sel(this)">She is defined by how others see her — reputation, standing, image in the community is the architecture of her self</div>
        </div>
      </div>
    </div>

    <!-- CH.2 -->
    <div class="chapter">
      <span class="ch-num">2</span> The First Encounter
      <div class="end-state toggle-block visible" id="ch2-es-safety">By the end, the reader's first impression of the primary as dangerous and hostile is established.</div>
      <div class="end-state toggle-block" id="ch2-es-identity">By the end, the reader understands why he is a threat to who she is. The enmity is personal.</div>
      <div class="employment-options" style="margin-top:10px"><div class="emp-header">How They Meet</div>
        <div class="emp-option" data-ch="2" data-opt="open_hostility" onclick="sel(this)">They meet already knowing — open hostility from the first moment</div>
        <div class="emp-option" data-ch="2" data-opt="meet_not_knowing" onclick="sel(this)">They meet not knowing — attraction or neutrality first, enmity surfaces</div>
        <div class="emp-option" data-ch="2" data-opt="asymmetric" onclick="sel(this)">One knows, the other doesn't — asymmetric power</div>
        <div class="emp-option" data-ch="2" data-opt="encounter_is_hostile" onclick="sel(this)">The encounter IS the hostile act</div>
        <div class="emp-option" data-ch="2" data-opt="forced_together" onclick="sel(this)">Forced into the same space by a third party or circumstance</div>
        <div class="constraint-note" id="ch2-constraint-safe">Constrained: "open hostility" unavailable when Ch.1 is "safe, stable, and unremarkable"</div>
      </div>

      <!-- SAFETY ENMITY -->
      <div class="toggle-block visible" id="ch2e-safety">
        <div class="employment-options" style="margin-top:10px"><div class="emp-header">Why They're Enemies</div>
          <div class="emp-option" data-ch="2e" data-opt="rivals" onclick="sel(this)">They are rivals competing over the same thing or resource</div>
          <div class="emp-option" data-ch="2e" data-opt="opposite_sides" onclick="sel(this)">They are enemies on opposite sides of an external conflict</div>
          <div class="emp-option" data-ch="2e" data-opt="acquiring" onclick="sel(this)">He is trying to acquire what she already has</div>
          <div class="emp-option" data-ch="2e" data-opt="she_pursues" onclick="sel(this)">She is an authority figure pursuing him</div>
          <div class="emp-option" data-ch="2e" data-opt="he_threatens" onclick="sel(this)">He is an authority figure threatening her livelihood</div>
          <div class="constraint-note" id="ch2e-constraint-safe">Constrained: "rivals" and "opposite sides" unavailable when Ch.1 is "safe, stable, and unremarkable"</div>
        </div>
      </div>

      <!-- IDENTITY ENMITY — COMPETENCE -->
      <div class="toggle-block" id="ch2e-competence">
        <div class="employment-options" style="margin-top:10px"><div class="emp-header">Why They're Enemies — Competence</div>
          <div class="emp-option" data-ch="2ei" data-opt="hes_better" onclick="sel(this)">He's better than her at the thing that defines her</div>
          <div class="emp-option" data-ch="2ei" data-opt="dismisses_skill" onclick="sel(this)">He dismisses her skill as irrelevant — wins a different way</div>
          <div class="emp-option" data-ch="2ei" data-opt="effortless" onclick="sel(this)">He succeeds effortlessly at what she had to fight for</div>
          <div class="emp-option" data-ch="2ei" data-opt="exposes_flaw" onclick="sel(this)">He exposes a flaw in her competence she didn't know existed</div>
        </div>
      </div>

      <!-- IDENTITY ENMITY — PRINCIPLES -->
      <div class="toggle-block" id="ch2e-principles">
        <div class="employment-options" style="margin-top:10px"><div class="emp-header">Why They're Enemies — Principles</div>
          <div class="emp-option" data-ch="2ei" data-opt="embodies_wrong" onclick="sel(this)">He embodies what she believes is wrong and thrives</div>
          <div class="emp-option" data-ch="2ei" data-opt="opposing_works" onclick="sel(this)">He lives by an opposing philosophy and it works</div>
          <div class="emp-option" data-ch="2ei" data-opt="celebrated" onclick="sel(this)">He acts against her principles and people celebrate him for it</div>
          <div class="emp-option" data-ch="2ei" data-opt="blind_spot" onclick="sel(this)">He proves her framework has a blind spot she can't explain away</div>
        </div>
      </div>

      <!-- IDENTITY ENMITY — ROLE -->
      <div class="toggle-block" id="ch2e-role">
        <div class="employment-options" style="margin-top:10px"><div class="emp-header">Why They're Enemies — Role</div>
          <div class="emp-option" data-ch="2ei" data-opt="role_impossible" onclick="sel(this)">He makes the role impossible to perform</div>
          <div class="emp-option" data-ch="2ei" data-opt="role_forbids" onclick="sel(this)">He offers her something the role forbids her from wanting</div>
          <div class="emp-option" data-ch="2ei" data-opt="sees_past_role" onclick="sel(this)">He sees her apart from the role and she finds that threatening</div>
          <div class="emp-option" data-ch="2ei" data-opt="step_outside" onclick="sel(this)">He needs something from her that requires stepping outside the role</div>
        </div>
      </div>

      <!-- IDENTITY ENMITY — REJECTION -->
      <div class="toggle-block" id="ch2e-rejection">
        <div class="employment-options" style="margin-top:10px"><div class="emp-header">Why They're Enemies — Rejection</div>
          <div class="emp-option" data-ch="2ei" data-opt="is_rejected_thing" onclick="sel(this)">He IS the thing she rejected — same class, same world, same past</div>
          <div class="emp-option" data-ch="2ei" data-opt="proud_of_shame" onclick="sel(this)">He's proud of what she's ashamed of</div>
          <div class="emp-option" data-ch="2ei" data-opt="sees_through" onclick="sel(this)">He sees through her reinvention</div>
          <div class="emp-option" data-ch="2ei" data-opt="makes_appealing" onclick="sel(this)">He makes the rejected thing look appealing</div>
        </div>
      </div>

      <!-- IDENTITY ENMITY — REPUTATION -->
      <div class="toggle-block" id="ch2e-reputation">
        <div class="employment-options" style="margin-top:10px"><div class="emp-header">Why They're Enemies — Reputation</div>
          <div class="emp-option" data-ch="2ei" data-opt="destroys_standing" onclick="sel(this)">Association with him would destroy her standing</div>
          <div class="emp-option" data-ch="2ei" data-opt="publicly_despised" onclick="sel(this)">He's publicly despised by the people whose opinion she needs</div>
          <div class="emp-option" data-ch="2ei" data-opt="doesnt_care" onclick="sel(this)">He doesn't care about reputation and that itself is a threat</div>
          <div class="emp-option" data-ch="2ei" data-opt="sees_gap" onclick="sel(this)">He sees the gap between who she is and who people think she is</div>
        </div>
      </div>
    </div>

    <!-- CH.3 TRIANGLE -->
    <div class="toggle-block" id="ch3-triangle">
      <div class="chapter">
        <span class="ch-num">3</span> The Safe Option
        <div class="end-state" id="ch3t-endstate-existing" style="display:none">By the end, the reader sees the first crack in the shelter.</div>
        <div class="end-state" id="ch3t-endstate-new" style="display:none">By the end, the reader sees a credible alternative to the conflict.</div>
        <div class="end-state" id="ch3t-endstate-default">End state determined by employment option selection.</div>
        <div class="employment-options"><div class="emp-header">Employment Options</div>
          <div class="emp-option" data-ch="3t" data-opt="already_in_life" onclick="sel(this)">He's already in her life — the safe option fails her for the first time</div>
          <div class="emp-option" data-ch="3t" data-opt="presents_solution" onclick="sel(this)">He presents himself as a solution to the problem the primary represents</div>
          <div class="constraint-note" id="ch3t-constraint">Constrained: "presents as solution" unavailable when Ch.2 enmity is "opposite sides" or "she pursues him"</div>
        </div>
        <div class="sub-options" id="ch3t-flaw-options">
          <div class="emp-header">The First Crack — Rival's Flaw (Already In Her Life)</div>
          <div class="emp-option" data-ch="3tf" data-opt="cowardice" onclick="sel(this)">Cowardice — he can't protect her</div>
          <div class="emp-option" data-ch="3tf" data-opt="indifference" onclick="sel(this)">Indifference — he won't protect her</div>
          <div class="cascading-note">↳ This flaw cascades — same flaw escalates through Ch.5, Ch.6, and Act III</div>
        </div>
      </div>
    </div>

    <!-- CH.3 NO TRIANGLE -->
    <div class="toggle-block" id="ch3-notriangle">
      <div class="chapter">
        <span class="ch-num">3</span> The Safe Path
        <div class="end-state">By the end, the reader sees a credible way out that doesn't involve him.</div>
        <div class="employment-options"><div class="emp-header">Employment Options</div>
          <div class="emp-option" data-ch="3nt" data-opt="leave" onclick="sel(this)">She could leave — abandon the situation entirely, start over elsewhere</div>
          <div class="emp-option" data-ch="3nt" data-opt="comply" onclick="sel(this)">She could comply — accept the terms, lose something but survive</div>
          <div class="emp-option" data-ch="3nt" data-opt="surrender" onclick="sel(this)">She could surrender what's at stake — cut her losses</div>
          <div class="emp-option" data-ch="3nt" data-opt="retreat" onclick="sel(this)">She could retreat into her existing world — withdraw behind existing structures</div>
          <div class="emp-option" data-ch="3nt" data-opt="official" onclick="sel(this)">She could pursue resolution through official channels — use the system</div>
        </div>
      </div>
    </div>

    <!-- CH.3 IDENTITY — THE REJECTION -->
    <div class="toggle-block" id="ch3-identity">
      <div class="chapter">
        <span class="ch-num">3</span> The Rejection
        <div class="end-state">By the end, the reader sees how strong the wall is. She has rejected him, misread what's real, and reinforced the identity. The reader sees what she can't.</div>
        <div class="employment-options"><div class="emp-header">Employment Options</div>
          <div class="emp-option" data-ch="3i" data-opt="weaponises_identity" onclick="sel(this)">She uses her identity as a weapon against him — the very thing that defines her becomes the instrument of rejection</div>
          <div class="emp-option" data-ch="3i" data-opt="categorises" onclick="sel(this)">She categorises and dismisses him — her framework slots him, labels him, and she's done. He's a type she already understands</div>
          <div class="emp-option" data-ch="3i" data-opt="doubles_down" onclick="sel(this)">She doubles down on being more herself — doesn't engage with the threat, just becomes louder, sharper, more committed to who she already is</div>
          <div class="emp-option" data-ch="3i" data-opt="humiliates_publicly" onclick="sel(this)">She humiliates him publicly — the rejection is performative. Others witness it. Her identity is reinforced socially. Now she can't back down without losing face</div>
        </div>
      </div>
    </div>

    <!-- CH.4 IDENTITY — THE PERSISTENCE -->
    <div class="toggle-block" id="ch4-identity">
      <div class="chapter">
        <span class="ch-num">4</span> The Persistence
        <div class="end-state">By the end, he is a fixture she can't remove. Her rejection failed.</div>
        <div class="employment-options"><div class="emp-header">Employment Options</div>
          <div class="emp-option" data-ch="4i" data-opt="keeps_showing_up" onclick="sel(this)">He keeps showing up in her space — she can't avoid him without changing her own routine</div>
          <div class="emp-option" data-ch="4i" data-opt="matches_her" onclick="sel(this)">He matches her — she pushes, he pushes back with wit or competence. He won't retreat</div>
          <div class="emp-option" data-ch="4i" data-opt="does_without_asking" onclick="sel(this)">He does something for her without asking — no performance. She finds out after</div>
          <div class="emp-option" data-ch="4i" data-opt="shows_up_differently" onclick="sel(this)">He shows up differently than expected — she can't stabilise her framework because he won't stay in the box</div>
          <div class="emp-option" data-ch="4i" data-opt="forced_obligation" onclick="sel(this)">They're forced into shared obligation — she can't exit without sacrificing something her identity depends on</div>
        </div>
      </div>
    </div>

    <!-- CH.4 SAFETY — THE ESCALATION -->
    <div class="toggle-block visible" id="ch4-block">
      <div class="chapter">
        <span class="ch-num">4</span> The Escalation
        <div class="end-state">By the end, she is locked into contact with him and her fear is confirmed. But the primary has noticed her and is attracted.</div>
        <div class="employment-options"><div class="emp-header">Employment Options</div>
          <div class="emp-option" data-ch="4" data-opt="targets_her" onclick="sel(this)">The conflict targets her specifically — becomes personal</div>
          <div class="emp-option" data-ch="4" data-opt="forced_proximity" onclick="sel(this)">She's forced into repeated proximity — avoidance impossible</div>
          <div class="emp-option" data-ch="4" data-opt="stakes_increase" onclick="sel(this)">The stakes increase — what she stands to lose grows larger</div>
          <div class="emp-option" data-ch="4" data-opt="demonstrates_danger" onclick="sel(this)">He demonstrates his capacity for danger — she witnesses it</div>
          <div class="emp-option" data-ch="4" data-opt="given_responsibility" onclick="sel(this)">She's given responsibility she can't refuse</div>
        </div>
      </div>
    </div>

  </div></div>
</div>

<!-- ════════════════════════════════ ACT II ════════════════════════════════ -->
<div class="act">
  <div class="act-label"><span class="act-number">Act II</span><span class="act-name">The Fall</span></div>
  <div class="act-content"><div class="chapters">

    <!-- CH.5 SAFETY -->
    <div class="toggle-block visible" id="ch5-safety">
      <div class="chapter">
        <span class="ch-num" id="ch5-num-safety">5</span> The Crack
        <div class="end-state">By the end, her first impression of the primary is broken. She can no longer maintain he is simply dangerous.</div>
        <div class="employment-options"><div class="emp-header">How the primary cracks her impression</div>
          <div class="emp-option" data-ch="5" data-opt="protects_her" onclick="sel(this)">He protects her when he has no reason to</div>
          <div class="emp-option" data-ch="5" data-opt="shows_restraint" onclick="sel(this)">He shows restraint or mercy when she expects aggression</div>
          <div class="emp-option" data-ch="5" data-opt="witnessed_vulnerable" onclick="sel(this)">She witnesses him vulnerable in a moment he didn't intend her to see</div>
          <div class="emp-option" data-ch="5" data-opt="sacrifices_for_other" onclick="sel(this)">He sacrifices something for someone other than her</div>
        </div>
        <div class="toggle-block" id="ch5-cascade"><div class="cascading-note">↳ Rival's flaw escalates — same flaw from Ch.3, louder</div></div>
        <div class="toggle-block" id="ch5-flaw-options">
          <div class="employment-options" style="margin-top:8px"><div class="emp-header">Rival's Flaw Emerges (Presents as Solution)</div>
            <div class="emp-option" data-ch="5f" data-opt="greed" onclick="sel(this)">Greed — his solution conveniently benefits him more than her</div>
            <div class="emp-option" data-ch="5f" data-opt="wrath" onclick="sel(this)">Wrath — his charm slips, anger surfaces when challenged</div>
            <div class="cascading-note">↳ This flaw cascades — same flaw escalates through Ch.6 and Act III</div>
          </div>
        </div>
      </div>
    </div>

    <!-- CH.5 IDENTITY -->
    <div class="toggle-block" id="ch5-identity">
      <div class="chapter">
        <span class="ch-num">5</span> The Crack
        <div class="end-state">By the end, her framework is broken. She can no longer maintain he is what she decided he was.</div>
        <div class="employment-options"><div class="emp-header">How the primary cracks her framework</div>
          <div class="emp-option" data-ch="5i" data-opt="defies_framework" onclick="sel(this)">He does something her framework says he shouldn't be capable of — he doesn't fit the box she put him in</div>
          <div class="emp-option" data-ch="5i" data-opt="sees_her" onclick="sel(this)">He sees something true about her that no one else has noticed — she can't dismiss someone who sees her clearly</div>
          <div class="emp-option" data-ch="5i" data-opt="genuinely_himself" onclick="sel(this)">She witnesses him being genuinely himself — the contrast between who he is and who she decided he was is undeniable</div>
          <div class="emp-option" data-ch="5i" data-opt="earns_respect" onclick="sel(this)">He earns respect from someone she respects — someone whose judgment she trusts disagrees with her framework</div>
        </div>
      </div>
    </div>

    <!-- CH.6 SAFETY -->
    <div class="toggle-block visible" id="ch6-safety">
      <div class="chapter">
        <span class="ch-num">6</span> The Fall
        <div class="end-state toggle-block" id="ch6-es-triangle">By the end, she has seen his depth, surrendered to the attraction. The line is nearly crossed. The rival senses the shift.</div>
        <div class="end-state toggle-block" id="ch6-es-notriangle">By the end, she has seen his depth, surrendered to the attraction. The line is nearly crossed.</div>
        <div class="employment-options"><div class="emp-header">How she falls</div>
          <div class="emp-option" data-ch="6" data-opt="there_for_her" onclick="sel(this)">He's there for her personally, disconnected from the conflict</div>
          <div class="emp-option" data-ch="6" data-opt="crisis_intimacy" onclick="sel(this)">A crisis forces intimacy — alone, walls drop, closeness</div>
          <div class="emp-option" data-ch="6" data-opt="enters_his_world" onclick="sel(this)">She enters his world and sees who he really is</div>
          <div class="emp-option" data-ch="6" data-opt="chooses_her" onclick="sel(this)">He chooses her over his own interests</div>
        </div>
        <div class="toggle-block" id="ch6-cascade"><div class="cascading-note">↳ Rival's flaw escalates further — degradation accelerates</div></div>
      </div>
    </div>

    <!-- CH.6 IDENTITY -->
    <div class="toggle-block" id="ch6-identity">
      <div class="chapter">
        <span class="ch-num">6</span> The Fall
        <div class="end-state">By the end, she has started becoming someone she doesn't recognise. The identity she built is no longer holding.</div>
        <div class="employment-options"><div class="emp-header">How she falls</div>
          <div class="emp-option" data-ch="6i" data-opt="likes_herself" onclick="sel(this)">She likes who she is around him — the version of herself that emerges feels more real than the constructed one</div>
          <div class="emp-option" data-ch="6i" data-opt="buried_part" onclick="sel(this)">He draws out a part of her she'd buried — something her identity required her to suppress comes back alive around him</div>
          <div class="emp-option" data-ch="6i" data-opt="his_world_home" onclick="sel(this)">She enters his world and finds herself at home — the thing she rejected or dismissed turns out to hold something she actually wanted</div>
          <div class="emp-option" data-ch="6i" data-opt="defends_him" onclick="sel(this)">She defends him when she doesn't have to — she catches herself doing it and knows the identity cracked without her permission</div>
        </div>
      </div>
    </div>

  </div></div>
</div>

<!-- ════════════════════════════════ ACT III ════════════════════════════════ -->
<div class="act">
  <div class="act-label"><span class="act-number">Act III</span><span class="act-name">The Retreat</span></div>
  <div class="act-content"><div class="chapters">

    <!-- ═══ CH.7 SAFETY ═══ -->
    <div class="toggle-block visible" id="ch7-safety">
      <div class="chapter">
        <span class="ch-num">7</span> The Dark Moment
        <div class="end-state">By the end, she believes it was too good to be true. He really is a monster. Every tender moment recontextualises.</div>

        <!-- SECRET ON -->
        <div class="toggle-block" id="ch7-secret-on">
          <div class="employment-options"><div class="emp-header">The Secret (what it is)</div>
            <div class="emp-option" data-ch="7secret" data-opt="hostile_motive" onclick="sel(this)">His original motive was hostile — he entered her life to harm her interests</div>
            <div class="emp-option" data-ch="7secret" data-opt="connected_threat" onclick="sel(this)">He is connected to the original threat — caused or part of what endangered her</div>
            <div class="emp-option" data-ch="7secret" data-opt="withheld_info" onclick="sel(this)">He withheld information that would have changed her choices</div>
          </div>
          <div class="employment-options" style="margin-top:10px"><div class="emp-header">How the secret surfaces</div>
            <div class="emp-option" data-ch="7surface" data-opt="discovers_herself" onclick="sel(this)">She discovers it herself — stumbles onto evidence</div>
            <div class="emp-option toggle-block" id="ch7-rival-exposes" data-ch="7surface" data-opt="rival_exposes" onclick="sel(this)">The rival exposes it</div>
            <div class="emp-option" data-ch="7surface" data-opt="third_party" onclick="sel(this)">A third party reveals it innocently</div>
            <div class="emp-option" data-ch="7surface" data-opt="primary_confesses" onclick="sel(this)">The primary confesses — too late</div>
            <div class="emp-option" data-ch="7surface" data-opt="forced_to_act" onclick="sel(this)">The primary is forced to act on the secret in front of her</div>
          </div>
        </div>

        <!-- SECRET OFF -->
        <div class="toggle-block" id="ch7-secret-off">
          <div class="employment-options"><div class="emp-header">What triggers the dark moment</div>
            <div class="emp-option" data-ch="7trigger" data-opt="reverts" onclick="sel(this)">He reverts to type — does something that confirms her original fear</div>
            <div class="emp-option" data-ch="7trigger" data-opt="conflict_resurfaces" onclick="sel(this)">The conflict between them resurfaces — the enmity reasserts itself</div>
            <div class="emp-option" data-ch="7trigger" data-opt="sees_cost" onclick="sel(this)">She sees the cost of choosing him — the danger becomes real and concrete again</div>
            <div class="emp-option" data-ch="7trigger" data-opt="someone_warns" onclick="sel(this)">Someone she trusts warns her — reframes everything as recklessness</div>
            <div class="emp-option" data-ch="7trigger" data-opt="self_sabotage" onclick="sel(this)">She sabotages it herself — her own safety instinct destroys what she built</div>
          </div>
        </div>

        <!-- RIVAL ROLE (triangle only) -->
        <div class="toggle-block" id="ch7-rival-section">
          <div class="employment-options" style="margin-top:10px"><div class="emp-header">Rival's role in the dark moment</div>
            <div class="emp-option" data-ch="7rival" data-opt="active" onclick="sel(this)">Active — he engineers or manipulates the dark moment</div>
            <div class="emp-option" data-ch="7rival" data-opt="passive" onclick="sel(this)">Passive — he benefits and opens his arms when she arrives</div>
            <div class="constraint-note" id="ch7-constraint-active">Fixed: Active — rival "presents as solution" always acts to protect his position</div>
            <div class="constraint-note" id="ch7-constraint-passive">Fixed: Passive — rival "already in her life" absorbs her return</div>
          </div>

          <!-- MANIPULATION — secret on + active -->
          <div class="toggle-block" id="ch7-manipulation">
            <div class="employment-options" style="margin-top:10px"><div class="emp-header">How the rival weaponises the secret (Active + Secret)</div>
              <div class="emp-option" data-ch="7manip" data-opt="strips_context" onclick="sel(this)">Strips context — removes the part where the primary changed</div>
              <div class="emp-option" data-ch="7manip" data-opt="engineers_timing" onclick="sel(this)">Engineers timing — deploys at maximum damage</div>
              <div class="emp-option" data-ch="7manip" data-opt="exaggerates" onclick="sel(this)">Fabricates or exaggerates details</div>
              <div class="emp-option" data-ch="7manip" data-opt="uses_proxy" onclick="sel(this)">Uses a proxy — hands look clean</div>
            </div>
          </div>

          <!-- MANIPULATION — secret off + active -->
          <div class="toggle-block" id="ch7-manipulation-nosecret">
            <div class="employment-options" style="margin-top:10px"><div class="emp-header">How the rival engineers the dark moment (Active + No Secret)</div>
              <div class="emp-option" data-ch="7manipns" data-opt="manufactures_situation" onclick="sel(this)">Manufactures a situation that forces the primary to act in a way that confirms her original fear</div>
              <div class="emp-option" data-ch="7manipns" data-opt="reframes_actions" onclick="sel(this)">Reframes the primary's actions — poisons her interpretation of what she's seen</div>
              <div class="emp-option" data-ch="7manipns" data-opt="provokes_primary" onclick="sel(this)">Provokes the primary into reverting to type — goads him into aggression she witnesses</div>
              <div class="emp-option" data-ch="7manipns" data-opt="confronts_cost" onclick="sel(this)">Confronts her with the cost — forces her to see what choosing the primary means for her world</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══ CH.7 IDENTITY ═══ -->
    <div class="toggle-block" id="ch7-identity">
      <div class="chapter">
        <span class="ch-num">7</span> The Dark Moment
        <div class="end-state">By the end, she believes the fall was the lie. Her original framework was right. The person she was becoming around him was built on nothing.</div>

        <!-- SECRET ON -->
        <div class="toggle-block" id="ch7i-secret-on">
          <div class="employment-options"><div class="emp-header">The Secret (what it is)</div>
            <div class="emp-option" data-ch="7isecret" data-opt="manufactured" onclick="sel(this)">His approach to her was manufactured — someone arranged it, paid for it, or orchestrated it. The persistence wasn't real</div>
            <div class="emp-option" data-ch="7isecret" data-opt="ulterior" onclick="sel(this)">He had an ulterior motive — what looked like genuine interest was strategic. He needed something from her</div>
            <div class="emp-option" data-ch="7isecret" data-opt="used_intimacy" onclick="sel(this)">He used what he learned about her against her — the intimacy was intelligence gathering. The things she revealed became tools</div>
          </div>
          <div class="employment-options" style="margin-top:10px"><div class="emp-header">How the secret surfaces</div>
            <div class="emp-option" data-ch="7isurface" data-opt="discovers_herself" onclick="sel(this)">She discovers it herself — stumbles onto evidence</div>
            <div class="emp-option" data-ch="7isurface" data-opt="third_party" onclick="sel(this)">A third party reveals it innocently</div>
            <div class="emp-option" data-ch="7isurface" data-opt="primary_confesses" onclick="sel(this)">He confesses — too late</div>
            <div class="emp-option" data-ch="7isurface" data-opt="witnesses_motive" onclick="sel(this)">She witnesses him in a moment that exposes the motive</div>
          </div>
        </div>

        <!-- SECRET OFF -->
        <div class="toggle-block" id="ch7i-secret-off">
          <div class="employment-options"><div class="emp-header">What triggers the dark moment</div>
            <div class="emp-option" data-ch="7itrigger" data-opt="reverts" onclick="sel(this)">He reverts to type — does the exact thing she originally categorised him as. The framework snaps back into place</div>
            <div class="emp-option" data-ch="7itrigger" data-opt="sees_herself" onclick="sel(this)">She sees herself through someone else's eyes and doesn't recognise who she's become — the gap between her constructed self and her current self is horrifying</div>
            <div class="emp-option" data-ch="7itrigger" data-opt="pushes_too_far" onclick="sel(this)">He challenges the core of her identity directly — not by accident, deliberately. He pushes too far</div>
            <div class="emp-option" data-ch="7itrigger" data-opt="world_punishes" onclick="sel(this)">The world she built punishes her for changing — the people, the standing, the role she's been abandoning start to collapse</div>
            <div class="emp-option" data-ch="7itrigger" data-opt="self_sabotage" onclick="sel(this)">She sabotages it herself — the identity reasserts from inside. She can't tolerate who she's becoming and destroys what she built with him</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══ CH.8 SAFETY ═══ -->
    <div class="toggle-block visible" id="ch8-safety">
      <div class="chapter">
        <span class="ch-num">8</span> The Retreat
        <div class="end-state toggle-block" id="ch8-es-triangle">By the end, she has committed to the rival. Something is dead inside her. The reader sees what she's lost.</div>
        <div class="end-state toggle-block" id="ch8-es-notriangle">By the end, she has committed to the safe path. Something is dead inside her. The reader sees what she's lost.</div>
        <div class="employment-options"><div class="emp-header">How she retreats</div>
          <div class="emp-option" data-ch="8" data-opt="goes_cold" onclick="sel(this)">She goes cold — shuts everything down, becomes the version of herself that never fell</div>
          <div class="emp-option" data-ch="8" data-opt="performs_normalcy" onclick="sel(this)">She performs normalcy — accepts the terms, smiles when expected, dead behind the eyes</div>
          <div class="emp-option" data-ch="8" data-opt="destroys_evidence" onclick="sel(this)">She actively destroys evidence of the fall — burns letters, avoids places, cuts all connection</div>
          <div class="emp-option" data-ch="8" data-opt="doubles_down" onclick="sel(this)">She throws herself into the alternative — doubles down on the safe path as if to prove it was right</div>
        </div>
      </div>
    </div>

    <!-- ═══ CH.8 IDENTITY ═══ -->
    <div class="toggle-block" id="ch8-identity">
      <div class="chapter">
        <span class="ch-num">8</span> The Retreat
        <div class="end-state">By the end, she has rebuilt the wall. She is who she was before the fall — but the reader sees it's a performance now. Something is dead inside her.</div>
        <div class="employment-options"><div class="emp-header">How she retreats</div>
          <div class="emp-option" data-ch="8i" data-opt="back_to_self" onclick="sel(this)">She goes back to exactly who she was — same sharpness, same framework, same posture. But it doesn't fit anymore. The reader sees the seams</div>
          <div class="emp-option" data-ch="8i" data-opt="overcorrects" onclick="sel(this)">She overcorrects — becomes a harder version of her constructed self than she ever was before. The identity isn't natural anymore, it's armour</div>
          <div class="emp-option" data-ch="8i" data-opt="cuts_everything" onclick="sel(this)">She cuts everything associated with the fall — avoids places, drops habits, removes anything that reminds her of who she was becoming</div>
          <div class="emp-option" data-ch="8i" data-opt="public_recommit" onclick="sel(this)">She publicly recommits to her identity — makes a show of it. Takes a stand or makes a decision in front of others so she can't go back</div>
        </div>
      </div>
    </div>

  </div></div>
</div>

<!-- ════════════════════════════════ ACT IV — HEA / BITTERSWEET ════════════════════════════════ -->
<div class="act toggle-block" id="act4-heabitter">
  <div class="act-label"><span class="act-number">Act IV</span><span class="act-name">The Resolution</span></div>
  <div class="act-content"><div class="chapters">

    <!-- ═══ SAFETY ACT IV ═══ -->
    <div class="toggle-block visible" id="act4-safety">

      <!-- CH.9 — SECRET ON -->
      <div class="toggle-block" id="ch9-secret">
        <div class="chapter">
          <span class="ch-num">9</span> The Full Picture
          <div class="end-state toggle-block" id="ch9-es-active">By the end, she learns the truth was distorted. The rival's manipulation is exposed. His feelings were real.</div>
          <div class="end-state toggle-block" id="ch9-es-passive">By the end, she learns the truth was incomplete. He changed, tried to stop, sacrificed the thing the secret was about.</div>
          <div class="end-state toggle-block" id="ch9-es-notriangle-secret">By the end, she learns the truth was incomplete. He changed, tried to stop, sacrificed the thing the secret was about.</div>
          <div class="employment-options"><div class="emp-header">How she learns the full picture</div>
            <div class="emp-option" data-ch="9fp" data-opt="evidence_surfaces" onclick="sel(this)">Evidence surfaces that reveals the full context</div>
            <div class="emp-option" data-ch="9fp" data-opt="ally_tells_her" onclick="sel(this)">Someone from the primary's world tells her the truth he couldn't</div>
            <div class="emp-option toggle-block" id="ch9-rival-slips" data-ch="9fp" data-opt="rival_slips" onclick="sel(this)">The rival overplays his hand — manipulation becomes visible</div>
            <div class="emp-option" data-ch="9fp" data-opt="primary_acts" onclick="sel(this)">The primary acts to protect her at great cost</div>
          </div>
        </div>
      </div>

      <!-- CH.9 — SECRET OFF -->
      <div class="toggle-block" id="ch9-nosecret">
        <div class="chapter">
          <span class="ch-num">9</span> The Grand Gesture
          <div class="end-state">By the end, he has proven through action that his feelings are real. The gesture is restorative and self-sacrificing.</div>
          <div class="employment-options"><div class="emp-header">The grand gesture</div>
            <div class="emp-option" data-ch="9gg" data-opt="undoes_harm" onclick="sel(this)">He undoes the harm he caused — reverses or repairs the damage from the original conflict</div>
            <div class="emp-option" data-ch="9gg" data-opt="protects_hers" onclick="sel(this)">He protects what she stands to lose — at cost to himself</div>
            <div class="emp-option" data-ch="9gg" data-opt="sacrifices_position" onclick="sel(this)">He sacrifices his position or power for her benefit</div>
            <div class="emp-option" data-ch="9gg" data-opt="chooses_her_world" onclick="sel(this)">He chooses her world over his own — abandons his side</div>
          </div>
        </div>
      </div>

      <!-- CH.10 — REUNITED -->
      <div class="chapter">
        <span class="ch-num">10</span> Reunited
        <div class="end-state">By the end, everything is on the table. No secrets, no armour. She chooses him. The consummation.</div>
        <div class="employment-options"><div class="emp-header">How they come back together</div>
          <div class="emp-option" data-ch="10" data-opt="she_goes_to_him" onclick="sel(this)">She goes to him — she initiates</div>
          <div class="emp-option" data-ch="10" data-opt="he_comes_for_her" onclick="sel(this)">He comes for her — risks everything to reach her</div>
          <div class="emp-option" data-ch="10" data-opt="forced_together_again" onclick="sel(this)">Circumstance forces them together — the choice happens in the moment</div>
        </div>
      </div>

      <!-- CH.11 — RIVAL NEUTRALISED (triangle only) -->
      <div class="toggle-block" id="ch11-triangle">
        <div class="chapter">
          <span class="ch-num">11</span> The Rival Neutralised
          <div class="end-state">By the end, the rival is removed as a threat. The safe option is gone. There is no going back.</div>
          <div class="employment-options"><div class="emp-header">How the rival is neutralised</div>
            <div class="emp-option" data-ch="11" data-opt="exposed" onclick="sel(this)">Exposed — his true nature becomes public</div>
            <div class="emp-option" data-ch="11" data-opt="defeated" onclick="sel(this)">Defeated — his attempt to destroy or reclaim fails</div>
            <div class="emp-option" data-ch="11" data-opt="walks_away" onclick="sel(this)">Walks away — sees the truth and leaves</div>
            <div class="emp-option" data-ch="11" data-opt="destroyed_by_flaw" onclick="sel(this)">Destroyed by his own flaw — the crack from Ch.3 finally breaks him</div>
          </div>
        </div>
      </div>

      <!-- CH.12 — HEA -->
      <div class="toggle-block" id="ch12-hea">
        <div class="chapter">
          <span class="ch-num" id="ch12-hea-num">12</span> HEA
          <div class="end-state">By the end, she has secured what matters. He has committed to protect it. They choose each other — not safety, not danger. Just together.</div>
        </div>
      </div>

      <!-- CH.12 — BITTERSWEET -->
      <div class="toggle-block" id="ch12-bitter">
        <div class="chapter">
          <span class="ch-num" id="ch12-bitter-num">12</span> Together, But At a Cost
          <div class="end-state">By the end, they choose each other. But the reader feels what it cost.</div>

          <div class="toggle-block" id="ch12-bitter-triangle">
            <div class="employment-options"><div class="emp-header">What was lost (with triangle)</div>
              <div class="emp-option" data-ch="12bt" data-opt="dignity_lost_rival" onclick="sel(this)">The dignified life character is lost as a consequence of the rival's actions</div>
              <div class="emp-option" data-ch="12bt" data-opt="rival_destroys" onclick="sel(this)">The rival destroys something irreplaceable before he's neutralised</div>
              <div class="emp-option" data-ch="12bt" data-opt="passion_pays" onclick="sel(this)">The passion character paid the price — her recklessness caught up with her in the crossfire</div>
              <div class="emp-option" data-ch="12bt" data-opt="lost_defending" onclick="sel(this)">She lost what she was defending — the thing from Ch.1 is gone</div>
              <div class="emp-option" data-ch="12bt" data-opt="his_cost" onclick="sel(this)">He lost his position or his people — the cost fell on his side for choosing her</div>
              <div class="emp-option" data-ch="12bt" data-opt="world_closed" onclick="sel(this)">Her world no longer accepts her — she chose the enemy, the community is closed to her</div>
            </div>
          </div>

          <div class="toggle-block" id="ch12-bitter-notriangle">
            <div class="employment-options"><div class="emp-header">What was lost (without triangle)</div>
              <div class="emp-option" data-ch="12bnt" data-opt="lost_defending" onclick="sel(this)">She lost what she was defending — the thing established in Ch.1 is gone</div>
              <div class="emp-option" data-ch="12bnt" data-opt="dignity_lost_conflict" onclick="sel(this)">The dignified life character is lost to the conflict</div>
              <div class="emp-option" data-ch="12bnt" data-opt="his_cost" onclick="sel(this)">He lost his position or his people — the cost fell on his side</div>
              <div class="emp-option" data-ch="12bnt" data-opt="passion_pays" onclick="sel(this)">The passion character paid the price of her own philosophy</div>
              <div class="emp-option" data-ch="12bnt" data-opt="warning_true" onclick="sel(this)">The burned by danger character's warning came true — not about him, but about the cost</div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- ═══ IDENTITY ACT IV (HEA ONLY) ═══ -->
    <div class="toggle-block" id="act4-identity">

      <!-- CH.9 IDENTITY — SECRET ON -->
      <div class="toggle-block" id="ch9i-secret">
        <div class="chapter">
          <span class="ch-num">9</span> The Full Picture
          <div class="end-state">By the end, she learns the fall was real. What she built with him was genuine. The framework was the lie, not the feelings.</div>
          <div class="employment-options"><div class="emp-header">How she learns the full picture</div>
            <div class="emp-option" data-ch="9ifp" data-opt="evidence_surfaces" onclick="sel(this)">Evidence surfaces that reveals the full context</div>
            <div class="emp-option" data-ch="9ifp" data-opt="ally_tells_her" onclick="sel(this)">Someone from his world tells her what was real</div>
            <div class="emp-option" data-ch="9ifp" data-opt="primary_acts" onclick="sel(this)">He acts to protect her at great cost — proving the motive changed</div>
          </div>
        </div>
      </div>

      <!-- CH.9 IDENTITY — SECRET OFF -->
      <div class="toggle-block" id="ch9i-nosecret">
        <div class="chapter">
          <span class="ch-num">9</span> The Grand Gesture
          <div class="end-state">By the end, he has proven through action that the person she was becoming around him was the real one.</div>
          <div class="employment-options"><div class="emp-header">The grand gesture</div>
            <div class="emp-option" data-ch="9igg" data-opt="shows_up_himself" onclick="sel(this)">He shows up as himself — no performance, no strategy, just vulnerable</div>
            <div class="emp-option" data-ch="9igg" data-opt="does_impossible" onclick="sel(this)">He does the thing her framework said he was incapable of — and it costs him</div>
            <div class="emp-option" data-ch="9igg" data-opt="lets_her_go" onclick="sel(this)">He lets her go — and that act of release is what breaks her framework permanently</div>
            <div class="emp-option" data-ch="9igg" data-opt="fights_for_her" onclick="sel(this)">He fights for her in a way that only makes sense if the fall was real</div>
          </div>
        </div>
      </div>

      <!-- CH.10 IDENTITY — REUNITED -->
      <div class="chapter">
        <span class="ch-num">10</span> Reunited
        <div class="end-state">By the end, she chooses him knowing it means becoming someone new. She lets the constructed self go.</div>
        <div class="employment-options"><div class="emp-header">How they come back together</div>
          <div class="emp-option" data-ch="10i" data-opt="she_goes_to_him" onclick="sel(this)">She goes to him — she initiates</div>
          <div class="emp-option" data-ch="10i" data-opt="he_comes_for_her" onclick="sel(this)">He comes for her</div>
          <div class="emp-option" data-ch="10i" data-opt="forced_together_again" onclick="sel(this)">Circumstance forces them together — the choice happens in the moment</div>
        </div>
      </div>

      <!-- CH.11 IDENTITY — HEA -->
      <div class="chapter">
        <span class="ch-num">11</span> HEA
        <div class="end-state">By the end, she is someone new — not the constructed self, not a stranger. Her. The reader sees who she was always going to be.</div>
      </div>

    </div>

  </div></div>
</div>

<!-- ════════════════════════════════ ACT IV — TRAGEDY ════════════════════════════════ -->
<div class="act toggle-block" id="act4-tragedy">
  <div class="act-label"><span class="act-number">Act IV</span><span class="act-name">The Cost</span></div>
  <div class="act-content"><div class="chapters">

    <!-- CH.9 TRAGEDY — IRREVERSIBLE ACT -->
    <div class="chapter">
      <span class="ch-num">9</span> The Irreversible Act

      <div class="toggle-block" id="ch9t-triangle">
        <div class="end-state">By the end, someone has acted on the lie. The damage cannot be undone.</div>
        <div class="employment-options"><div class="emp-header">The irreversible act</div>
          <div class="emp-option" data-ch="9t" data-opt="rival_kills" onclick="sel(this)">The rival kills him — jealousy or rage</div>
          <div class="emp-option" data-ch="9t" data-opt="she_betrays" onclick="sel(this)">She betrays him to his enemies while still in her dark moment</div>
          <div class="emp-option" data-ch="9t" data-opt="she_fails" onclick="sel(this)">She fails to act when she could have saved him — her retreat has consequences</div>
        </div>
      </div>

      <div class="toggle-block" id="ch9t-notriangle">
        <div class="end-state">By the end, the damage cannot be undone.</div>
        <div class="employment-options"><div class="emp-header">The irreversible act</div>
          <div class="emp-option" data-ch="9tnt" data-opt="she_betrays" onclick="sel(this)">She betrays him to his enemies while still in her dark moment</div>
          <div class="emp-option" data-ch="9tnt" data-opt="she_fails" onclick="sel(this)">She fails to act when she could have saved him</div>
          <div class="emp-option" data-ch="9tnt" data-opt="conflict_destroys" onclick="sel(this)">The conflict itself destroys him — the thing that made them enemies kills him</div>
          <div class="emp-option" data-ch="9tnt" data-opt="was_monster" onclick="sel(this)">He was the monster all along — the fall was the lie, Act II was the con</div>
          <div class="cascading-note">↳ "Conflict destroys him" requires a setting with lethal stakes (war, crime, frontier)</div>
        </div>
      </div>
    </div>

    <!-- CH.10 TRAGEDY — TRUTH TOO LATE (default) -->
    <div class="toggle-block" id="ch10t-truth">
      <div class="chapter">
        <span class="ch-num">10</span> The Truth Arrives Too Late
        <div class="end-state">By the end, she knows the full picture. But he's already gone.</div>
        <div class="employment-options"><div class="emp-header">How the truth reaches her</div>
          <div class="emp-option" data-ch="10t" data-opt="evidence_surfaces" onclick="sel(this)">Evidence surfaces that reveals the full context</div>
          <div class="emp-option" data-ch="10t" data-opt="ally_tells_her" onclick="sel(this)">Someone from his world tells her the truth he couldn't</div>
          <div class="emp-option" data-ch="10t" data-opt="primary_left_proof" onclick="sel(this)">He left proof — a letter, a document, an act she discovers after</div>
        </div>
      </div>
    </div>

    <!-- CH.10 TRAGEDY — CONFIRMATION (monster all along) -->
    <div class="toggle-block" id="ch10t-monster">
      <div class="chapter">
        <span class="ch-num">10</span> The Full Extent
        <div class="end-state">By the end, she discovers the dark moment was only the surface. It's worse than she thought.</div>
        <div class="employment-options"><div class="emp-header">How the full extent is revealed</div>
          <div class="emp-option" data-ch="10tm" data-opt="discovers_more" onclick="sel(this)">She discovers additional evidence — the deception ran deeper than the secret</div>
          <div class="emp-option" data-ch="10tm" data-opt="he_reveals" onclick="sel(this)">He reveals himself fully — no longer needs to pretend</div>
          <div class="emp-option" data-ch="10tm" data-opt="others_emerge" onclick="sel(this)">Other victims emerge — she wasn't the first, the pattern becomes visible</div>
        </div>
      </div>
    </div>

    <!-- CH.11 TRAGEDY — THE CONSEQUENCE -->
    <div class="chapter">
      <span class="ch-num">11</span> The Consequence

      <!-- If rival killed him -->
      <div class="toggle-block" id="ch11t-rival-killed">
        <div class="end-state">By the end, the rival has paid for what he did.</div>
        <div class="employment-options"><div class="emp-header">The consequence</div>
          <div class="emp-option" data-ch="11trk" data-opt="she_destroys_rival" onclick="sel(this)">She destroys the rival — revenge</div>
          <div class="emp-option" data-ch="11trk" data-opt="exposes_rival" onclick="sel(this)">She exposes the rival publicly — his crime becomes known</div>
          <div class="emp-option" data-ch="11trk" data-opt="rival_self_destructs" onclick="sel(this)">The rival is destroyed by the consequences of his own act</div>
        </div>
      </div>

      <!-- If she betrayed or failed -->
      <div class="toggle-block" id="ch11t-she-caused">
        <div class="end-state">By the end, she faces what she's done.</div>
        <div class="employment-options"><div class="emp-header">The consequence</div>
          <div class="emp-option" data-ch="11tsc" data-opt="takes_life" onclick="sel(this)">She takes her own life — the guilt is unsurvivable</div>
          <div class="emp-option" data-ch="11tsc" data-opt="lives_with_it" onclick="sel(this)">She lives with it — the tragedy is endurance, not death</div>
          <div class="emp-option" data-ch="11tsc" data-opt="destroys_safe_path" onclick="sel(this)">She destroys what she retreated to — burns the safe path that made her complicit</div>
        </div>
      </div>

      <!-- If conflict destroyed him (no triangle) -->
      <div class="toggle-block" id="ch11t-conflict">
        <div class="end-state">By the end, she faces what the world has done.</div>
        <div class="employment-options"><div class="emp-header">The consequence</div>
          <div class="emp-option" data-ch="11tc" data-opt="takes_life" onclick="sel(this)">She takes her own life</div>
          <div class="emp-option" data-ch="11tc" data-opt="lives_with_it" onclick="sel(this)">She lives with it — the tragedy is endurance</div>
          <div class="emp-option" data-ch="11tc" data-opt="destroys_defended" onclick="sel(this)">She destroys what she was defending — nothing matters anymore</div>
        </div>
      </div>

      <!-- If he was the monster all along -->
      <div class="toggle-block" id="ch11t-monster">
        <div class="end-state">By the end, she faces what she gave herself to.</div>
        <div class="employment-options"><div class="emp-header">The consequence</div>
          <div class="emp-option" data-ch="11tmon" data-opt="destroys_him" onclick="sel(this)">She destroys him — turns his own weapons against him</div>
          <div class="emp-option" data-ch="11tmon" data-opt="escapes" onclick="sel(this)">She escapes — survival is the victory</div>
          <div class="emp-option" data-ch="11tmon" data-opt="lives_with_it" onclick="sel(this)">She lives with it — the tragedy is what she learned about herself</div>
        </div>
      </div>
    </div>

  </div></div>
</div>

</section>

<!-- SUMMARY -->
<div class="selection-summary">
  <div class="sum-header">Current Selections</div>
  <div id="summary-content"></div>
</div>

<footer>
  <span>inTongues — Blueprint System</span>
  <span id="footer-vars">Enemies to Lovers × Safety × HEA × Secret × Triangle</span>
</footer>

<script>
var S = {};
var lastTension = 'safety';
var ch1BlocksSolution = {opposite_sides:true, she_pursues:true};
var ch1SafeBlocks2 = {open_hostility:true};
var ch1SafeBlocks2e = {opposite_sides:true, rivals:true};

function getVar(id) { return document.getElementById(id).value; }

function sel(el) {
  if (el.classList.contains('disabled')) return;
  var ch = el.getAttribute('data-ch'), opt = el.getAttribute('data-opt');
  if (S[ch]===opt) { S[ch]=null; el.classList.remove('selected'); applyConstraints(); updateSummary(); return; }
  var prev=document.querySelectorAll('.emp-option[data-ch="'+ch+'"].selected');
  for(var i=0;i<prev.length;i++) prev[i].classList.remove('selected');
  S[ch]=opt; el.classList.add('selected'); applyConstraints(); updateSummary();
}

function clearCh(ch) {
  var els=document.querySelectorAll('.emp-option[data-ch="'+ch+'"].selected');
  for(var i=0;i<els.length;i++) els[i].classList.remove('selected');
  S[ch]=null;
}

function show(id) { var el=document.getElementById(id); if(el) el.classList.add('visible'); }
function hide(id) { var el=document.getElementById(id); if(el) el.classList.remove('visible'); }
function showEl(id) { var el=document.getElementById(id); if(el) el.style.display='block'; }
function hideEl(id) { var el=document.getElementById(id); if(el) el.style.display='none'; }

function updateAll() {
  var ending = getVar('ending');
  var secret = getVar('secret');
  var triangle = getVar('triangle');
  var tension = getVar('tension');

  // --- TENSION TOGGLES (cast + ch1 + ch2 enmity + ch3/ch4 + triangle lock) ---
  var triangleEl = document.getElementById('triangle');
  if (tension==='safety') {
    show('cast-safety'); hide('cast-identity');
    show('ch1-safety'); hide('ch1-identity');
    show('ch2e-safety');
    hide('ch2e-competence'); hide('ch2e-principles'); hide('ch2e-role'); hide('ch2e-rejection'); hide('ch2e-reputation');
    hide('ch3-identity'); hide('ch4-identity'); show('ch4-block');
    show('ch5-safety'); hide('ch5-identity');
    show('ch6-safety'); hide('ch6-identity');
    show('ch7-safety'); hide('ch7-identity');
    show('ch8-safety'); hide('ch8-identity');
    show('act4-safety'); hide('act4-identity');
    show('ch2-es-safety'); hide('ch2-es-identity');
    // Unlock ending for safety
    document.getElementById('ending').disabled = false;
    triangleEl.disabled = false;
  } else {
    hide('cast-safety'); show('cast-identity');
    hide('ch1-safety'); show('ch1-identity');
    hide('ch2e-safety');
    // Show identity enmity based on Ch.1 selection
    hide('ch2e-competence'); hide('ch2e-principles'); hide('ch2e-role'); hide('ch2e-rejection'); hide('ch2e-reputation');
    if (S[1]==='competence') show('ch2e-competence');
    else if (S[1]==='principles') show('ch2e-principles');
    else if (S[1]==='role') show('ch2e-role');
    else if (S[1]==='rejection') show('ch2e-rejection');
    else if (S[1]==='reputation') show('ch2e-reputation');
    // Identity: no triangle, no Ch.4, show identity Ch.3, Ch.5, Ch.6
    triangleEl.value = 'no'; triangleEl.disabled = true;
    triangle = 'no';
    show('ch3-identity'); show('ch4-identity'); hide('ch4-block');
    show('ch5-identity'); hide('ch5-safety');
    show('ch6-identity'); hide('ch6-safety');
    show('ch7-identity'); hide('ch7-safety');
    show('ch8-identity'); hide('ch8-safety');
    hide('act4-safety'); show('act4-identity');
    hide('ch2-es-safety'); show('ch2-es-identity');
    // Lock ending to HEA for identity
    var endingEl = document.getElementById('ending');
    endingEl.value = 'hea'; endingEl.disabled = true;
    ending = 'hea';
    clearCh('4'); clearCh('5'); clearCh('6'); clearCh('8');
  }
  // Clear selections when tension changes
  if (tension!==lastTension) { clearCh('1'); clearCh('2e'); clearCh('2ei'); clearCh('3i'); clearCh('3nt'); clearCh('3t'); clearCh('3tf'); clearCh('4'); clearCh('4i'); clearCh('5'); clearCh('5i'); clearCh('5f'); clearCh('6'); clearCh('6i'); clearCh('7secret'); clearCh('7surface'); clearCh('7trigger'); clearCh('7isecret'); clearCh('7isurface'); clearCh('7itrigger'); clearCh('8'); clearCh('8i'); clearCh('9fp'); clearCh('9gg'); clearCh('9ifp'); clearCh('9igg'); clearCh('10'); clearCh('10i'); clearCh('11'); lastTension=tension; }

  // --- TRIANGLE TOGGLES ---
  if (triangle==='yes') {
    show('ch3-triangle'); hide('ch3-notriangle'); hide('ch3-identity');
    if(tension==='safety') show('cast-rival-safety'); else show('cast-rival-identity');
    show('ch6-cascade');
    show('ch6-es-triangle'); hide('ch6-es-notriangle');
    show('ch7-rival-section');
    show('ch7-rival-exposes');
    show('ch8-es-triangle'); hide('ch8-es-notriangle');
    show('ch11-triangle');
    show('ch9-rival-slips');
    // Ch5 flaw/cascade depends on ch3 selection
    if (S['3t']==='presents_solution') { show('ch5-flaw-options'); hide('ch5-cascade'); }
    else if (S['3t']==='already_in_life') { hide('ch5-flaw-options'); show('ch5-cascade'); }
    else { hide('ch5-flaw-options'); hide('ch5-cascade'); }
    // Clear no-triangle selections
    clearCh('3nt');
  } else {
    hide('ch3-triangle'); if(tension==='safety') show('ch3-notriangle'); else hide('ch3-notriangle');
    hide('cast-rival-safety'); hide('cast-rival-identity');
    hide('ch5-cascade'); hide('ch5-flaw-options'); hide('ch6-cascade');
    hide('ch6-es-triangle'); show('ch6-es-notriangle');
    hide('ch7-rival-section');
    hide('ch7-rival-exposes');
    hide('ch8-es-triangle'); show('ch8-es-notriangle');
    hide('ch11-triangle');
    hide('ch9-rival-slips');
    // Clear triangle selections
    clearCh('3t'); clearCh('3tf'); clearCh('5f'); clearCh('7rival'); clearCh('7manip'); clearCh('7manipns'); clearCh('11');
    clearCh('12bt'); clearCh('9t');
    if(S['7surface']==='rival_exposes') clearCh('7surface');
    if(S['9fp']==='rival_slips') clearCh('9fp');
    document.getElementById('ch1-rival-note').classList.remove('visible');
  }

  // --- SECRET TOGGLES ---
  if (secret==='yes') {
    show('ch7-secret-on'); hide('ch7-secret-off');
    show('ch7i-secret-on'); hide('ch7i-secret-off');
    show('ch9-secret'); hide('ch9-nosecret');
    show('ch9i-secret'); hide('ch9i-nosecret');
    clearCh('7trigger'); clearCh('7itrigger'); clearCh('9gg'); clearCh('9igg'); clearCh('7manipns');
  } else {
    hide('ch7-secret-on'); show('ch7-secret-off');
    hide('ch7i-secret-on'); show('ch7i-secret-off');
    hide('ch9-secret'); show('ch9-nosecret');
    hide('ch9i-secret'); show('ch9i-nosecret');
    clearCh('7secret'); clearCh('7surface'); clearCh('7manip'); clearCh('9fp');
    clearCh('7isecret'); clearCh('7isurface'); clearCh('9ifp');
  }

  // --- ENDING TOGGLES ---
  if (ending==='tragic') {
    show('act4-tragedy'); hide('act4-heabitter');
    // Clear HEA/bitter selections
    clearCh('9fp'); clearCh('9gg'); clearCh('10'); clearCh('11');
    clearCh('12bt'); clearCh('12bnt');
  } else {
    hide('act4-tragedy'); show('act4-heabitter');
    // Clear tragedy selections
    clearCh('9t'); clearCh('9tnt'); clearCh('10t'); clearCh('10tm'); clearCh('11trk'); clearCh('11tsc'); clearCh('11tc'); clearCh('11tmon');

    if (ending==='hea') {
      show('ch12-hea'); hide('ch12-bitter');
      clearCh('12bt'); clearCh('12bnt');
    } else {
      hide('ch12-hea'); show('ch12-bitter');
      if (triangle==='yes') {
        show('ch12-bitter-triangle'); hide('ch12-bitter-notriangle');
        clearCh('12bnt');
      } else {
        hide('ch12-bitter-triangle'); show('ch12-bitter-notriangle');
        clearCh('12bt');
      }
    }
  }

  // Tragedy triangle toggles
  if (ending==='tragic') {
    if (triangle==='yes') {
      show('ch9t-triangle'); hide('ch9t-notriangle');
      clearCh('9tnt');
    } else {
      hide('ch9t-triangle'); show('ch9t-notriangle');
      clearCh('9t');
    }
  }

  // Manipulation: active + secret = weaponise secret; active + no secret = engineer dark moment
  if (S['7rival']==='active' && secret==='yes') {
    show('ch7-manipulation'); hide('ch7-manipulation-nosecret'); clearCh('7manipns');
  } else if (S['7rival']==='active' && secret==='no') {
    hide('ch7-manipulation'); show('ch7-manipulation-nosecret'); clearCh('7manip');
  } else {
    hide('ch7-manipulation'); hide('ch7-manipulation-nosecret'); clearCh('7manip'); clearCh('7manipns');
  }

  // Ch9 end states (HEA/bitter + secret)
  if (secret==='yes' && ending!=='tragic') {
    if (triangle==='yes') {
      if (S['7rival']==='active') { show('ch9-es-active'); hide('ch9-es-passive'); hide('ch9-es-notriangle-secret'); }
      else if (S['7rival']==='passive') { hide('ch9-es-active'); show('ch9-es-passive'); hide('ch9-es-notriangle-secret'); }
      else { hide('ch9-es-active'); hide('ch9-es-passive'); hide('ch9-es-notriangle-secret'); }
    } else {
      hide('ch9-es-active'); hide('ch9-es-passive'); show('ch9-es-notriangle-secret');
    }
  } else {
    hide('ch9-es-active'); hide('ch9-es-passive'); hide('ch9-es-notriangle-secret');
  }

  // Chapter numbers for HEA/bitter final chapter
  var hasTriangle = triangle==='yes';
  var lastNum = hasTriangle ? '12' : '11';
  var heaNum = document.getElementById('ch12-hea-num');
  var bitterNum = document.getElementById('ch12-bitter-num');
  if(heaNum) heaNum.textContent = lastNum;
  if(bitterNum) bitterNum.textContent = lastNum;

  // Tragedy Ch.11 consequence toggles
  updateTragedyConsequence();

  applyConstraints();
  updateSummary();
  updateFooter();
}

function updateTragedyConsequence() {
  var triangle = getVar('triangle');
  hide('ch11t-rival-killed'); hide('ch11t-she-caused'); hide('ch11t-conflict'); hide('ch11t-monster');
  hide('ch10t-truth'); hide('ch10t-monster');
  clearCh('11trk'); clearCh('11tsc'); clearCh('11tc'); clearCh('11tmon');
  clearCh('10t'); clearCh('10tm');

  if (getVar('ending')!=='tragic') return;

  if (triangle==='yes') {
    var act = S['9t'];
    show('ch10t-truth');
    if (act==='rival_kills') show('ch11t-rival-killed');
    else if (act==='she_betrays'||act==='she_fails') show('ch11t-she-caused');
  } else {
    var act = S['9tnt'];
    if (act==='was_monster') {
      show('ch10t-monster');
      show('ch11t-monster');
    } else {
      show('ch10t-truth');
      if (act==='she_betrays'||act==='she_fails') show('ch11t-she-caused');
      else if (act==='conflict_destroys') show('ch11t-conflict');
    }
  }
}

function applyConstraints() {
  var ch1=S[1], enmity=S['2e'], triangle=getVar('triangle'), secret=getVar('secret'), tension=getVar('tension');

  // Ch1 end state toggle
  hide('ch1-es-default'); hide('ch1-es-safe'); hide('ch1-es-identity');
  if (tension==='identity') {
    show('ch1-es-identity');
  } else if (ch1==='safe_stable') {
    show('ch1-es-safe');
  } else {
    show('ch1-es-default');
  }

  // Identity enmity — toggle based on Ch.1 and clear when Ch.1 changes
  if (tension==='identity') {
    var identityEnemySets = ['ch2e-competence','ch2e-principles','ch2e-role','ch2e-rejection','ch2e-reputation'];
    var ch1ToEnemy = {competence:'ch2e-competence',principles:'ch2e-principles',role:'ch2e-role',rejection:'ch2e-rejection',reputation:'ch2e-reputation'};
    var targetSet = ch1 ? ch1ToEnemy[ch1] : null;
    for(var i=0;i<identityEnemySets.length;i++){
      var setId=identityEnemySets[i];
      if(setId===targetSet) show(setId);
      else {
        var wasVisible=document.getElementById(setId) && document.getElementById(setId).classList.contains('visible');
        hide(setId);
        if(wasVisible && setId!==targetSet) clearCh('2ei');
      }
    }
  }

  // Ch1 safe_stable -> Ch2 constraints (safety only)
  var safeNote2=document.getElementById('ch2-constraint-safe');
  var safeNote2e=document.getElementById('ch2e-constraint-safe');
  safeNote2.classList.remove('visible'); safeNote2e.classList.remove('visible');

  // Reset ch2 and ch2e disabled states from this constraint
  document.querySelectorAll('.emp-option[data-ch="2"]').forEach(function(el){el.classList.remove('disabled');});
  document.querySelectorAll('.emp-option[data-ch="2e"]').forEach(function(el){el.classList.remove('disabled');});

  if (tension==='safety' && ch1==='safe_stable') {
    safeNote2.classList.add('visible'); safeNote2e.classList.add('visible');
    document.querySelectorAll('.emp-option[data-ch="2"]').forEach(function(el){
      if(ch1SafeBlocks2[el.getAttribute('data-opt')]){el.classList.add('disabled');if(S['2']===el.getAttribute('data-opt')){el.classList.remove('selected');S['2']=null;}}
    });
    document.querySelectorAll('.emp-option[data-ch="2e"]').forEach(function(el){
      if(ch1SafeBlocks2e[el.getAttribute('data-opt')]){el.classList.add('disabled');if(S['2e']===el.getAttribute('data-opt')){el.classList.remove('selected');S['2e']=null;}}
    });
  }

  // Enmity axis -> Ch3 constraint (triangle + safety only)
  if (triangle==='yes') {
    var solEl=document.querySelector('.emp-option[data-ch="3t"][data-opt="presents_solution"]');
    var solNote=document.getElementById('ch3t-constraint');
    solEl.classList.remove('disabled'); solNote.classList.remove('visible');
    if (tension==='safety' && enmity && ch1BlocksSolution[enmity]) {
      solEl.classList.add('disabled'); solNote.classList.add('visible');
      if(S['3t']==='presents_solution'){solEl.classList.remove('selected');S['3t']=null;}
    }

    // Ch3 triangle end states
    var ch3t = S['3t'];
    hideEl('ch3t-endstate-default'); hideEl('ch3t-endstate-existing'); hideEl('ch3t-endstate-new');
    var rivalNote=document.getElementById('ch1-rival-note');
    var flawOpts=document.getElementById('ch3t-flaw-options');

    if (ch3t==='already_in_life') {
      rivalNote.classList.add('visible'); flawOpts.classList.add('visible');
      showEl('ch3t-endstate-existing');
      show('ch5-cascade'); hide('ch5-flaw-options'); clearCh('5f');
    } else if (ch3t==='presents_solution') {
      rivalNote.classList.remove('visible'); flawOpts.classList.remove('visible');
      showEl('ch3t-endstate-new');
      clearCh('3tf');
      hide('ch5-cascade'); show('ch5-flaw-options');
    } else {
      rivalNote.classList.remove('visible'); flawOpts.classList.remove('visible');
      showEl('ch3t-endstate-default');
      hide('ch5-cascade'); hide('ch5-flaw-options'); clearCh('5f');
    }

    // Ch3 -> Ch7 rival role constraint
    var actEl=document.querySelector('.emp-option[data-ch="7rival"][data-opt="active"]');
    var pasEl=document.querySelector('.emp-option[data-ch="7rival"][data-opt="passive"]');
    var actNote=document.getElementById('ch7-constraint-active');
    var pasNote=document.getElementById('ch7-constraint-passive');
    actEl.classList.remove('disabled'); pasEl.classList.remove('disabled');
    actNote.classList.remove('visible'); pasNote.classList.remove('visible');

    if (ch3t==='presents_solution') {
      pasEl.classList.add('disabled'); actNote.classList.add('visible');
      if(S['7rival']==='passive'){pasEl.classList.remove('selected');S['7rival']=null;}
    } else if (ch3t==='already_in_life') {
      actEl.classList.add('disabled'); pasNote.classList.add('visible');
      if(S['7rival']==='active'){actEl.classList.remove('selected');S['7rival']=null;}
    }

    // Manipulation visibility
    if (S['7rival']==='active' && secret==='yes') { show('ch7-manipulation'); hide('ch7-manipulation-nosecret'); clearCh('7manipns'); }
    else if (S['7rival']==='active' && secret==='no') { hide('ch7-manipulation'); show('ch7-manipulation-nosecret'); clearCh('7manip'); }
    else { hide('ch7-manipulation'); hide('ch7-manipulation-nosecret'); clearCh('7manip'); clearCh('7manipns'); }

    // Ch9 end states update
    if (secret==='yes' && getVar('ending')!=='tragic') {
      hide('ch9-es-active'); hide('ch9-es-passive');
      if (S['7rival']==='active') show('ch9-es-active');
      else if (S['7rival']==='passive') show('ch9-es-passive');
    }
  }

  // Surface: rival_exposes forces active
  if (S['7surface']==='rival_exposes' && triangle==='yes') {
    var pasEl2=document.querySelector('.emp-option[data-ch="7rival"][data-opt="passive"]');
    pasEl2.classList.add('disabled');
    if(S['7rival']==='passive'){pasEl2.classList.remove('selected');S['7rival']=null;}
  }

  // Update tragedy consequence when ch9 selection changes
  updateTragedyConsequence();
  updateSummary();
}

function updateSummary() {
  var html='';
  var ending=getVar('ending'), secret=getVar('secret'), triangle=getVar('triangle');

  function addLine(label, ch) {
    if(S[ch]) html+='<div class="sum-item">'+label+': <span>'+S[ch].replace(/_/g,' ')+'</span></div>';
  }

  addLine('Ch.1 Her World','1');
  addLine('Ch.2 How They Meet','2');
  if(getVar('tension')==='safety') addLine('Ch.2 Why Enemies','2e');
  else addLine('Ch.2 Why Enemies','2ei');
  if(triangle==='yes') { addLine('Ch.3 Safe Option','3t'); addLine('Ch.3 Flaw','3tf'); }
  else if(getVar('tension')==='identity') addLine('Ch.3 Rejection','3i');
  else addLine('Ch.3 Safe Path','3nt');
  if(getVar('tension')==='safety') addLine('Ch.4 Escalation','4');
  else addLine('Ch.4 Persistence','4i');
  if(getVar('tension')==='safety') addLine('Ch.5 The Crack','5');
  else addLine('Ch.5 The Crack','5i');
  if(triangle==='yes' && getVar('tension')==='safety' && S['3t']==='presents_solution') addLine('Ch.5 Rival Flaw','5f');
  if(getVar('tension')==='safety') addLine('Ch.6 The Fall','6');
  else addLine('Ch.6 The Fall','6i');
  if(getVar('tension')==='safety') {
    if(secret==='yes') { addLine('Ch.7 Secret','7secret'); addLine('Ch.7 Surface','7surface'); }
    else addLine('Ch.7 Trigger','7trigger');
    if(triangle==='yes') { addLine('Ch.7 Rival','7rival'); addLine('Ch.7 Manipulation','7manip'); addLine('Ch.7 Manipulation','7manipns'); }
    addLine('Ch.8 Retreat','8');
  } else {
    if(secret==='yes') { addLine('Ch.7 Secret','7isecret'); addLine('Ch.7 Surface','7isurface'); }
    else addLine('Ch.7 Trigger','7itrigger');
    addLine('Ch.8 Retreat','8i');
  }

  if(getVar('tension')==='identity') {
    if(secret==='yes') addLine('Ch.9 Full Picture','9ifp');
    else addLine('Ch.9 Grand Gesture','9igg');
    addLine('Ch.10 Reunited','10i');
  } else if(ending==='tragic') {
    if(triangle==='yes') addLine('Ch.9 Irreversible','9t');
    else addLine('Ch.9 Irreversible','9tnt');
    addLine('Ch.10 Truth','10t');
    addLine('Ch.10 Full Extent','10tm');
    addLine('Ch.11 Consequence','11trk');
    addLine('Ch.11 Consequence','11tsc');
    addLine('Ch.11 Consequence','11tc');
    addLine('Ch.11 Consequence','11tmon');
  } else {
    if(secret==='yes') addLine('Ch.9 Full Picture','9fp');
    else addLine('Ch.9 Grand Gesture','9gg');
    addLine('Ch.10 Reunited','10');
    if(triangle==='yes') addLine('Ch.11 Rival','11');
    if(ending==='bittersweet') {
      if(triangle==='yes') addLine('Ch.12 Cost','12bt');
      else addLine('Ch.12 Cost','12bnt');
    }
  }

  document.getElementById('summary-content').innerHTML = html || '<div class="sum-item" style="opacity:0.4">No selections yet</div>';
}

function updateFooter() {
  var e=getVar('ending'), s=getVar('secret'), t=getVar('triangle'), tension=getVar('tension');
  var eL={hea:'HEA',bittersweet:'Bittersweet',tragic:'Tragic'};
  var sL={yes:'Secret',no:'No Secret'};
  var tL={yes:'Triangle',no:'No Triangle'};
  var tenL={safety:'Safety',identity:'Identity'};
  document.getElementById('footer-vars').textContent = 'Enemies to Lovers × '+tenL[tension]+' × '+eL[e]+' × '+sL[s]+' × '+tL[t];
}

// INIT
updateAll();
</script>

</body>
</html>
